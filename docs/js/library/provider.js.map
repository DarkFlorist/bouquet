{"version":3,"file":"provider.js","sourceRoot":"","sources":["../../ts/library/provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { batch, Signal } from '@preact/signals'\nimport { Block, BrowserProvider, getAddress, HDNodeWallet, Wallet } from 'ethers'\nimport { AddressParser, EthereumAddress } from '../types/ethereumTypes.js'\nimport { BlockInfo, Signers } from '../types/types.js'\nimport { fetchSettingsFromStorage } from '../stores.js'\nimport { BouquetSettings } from '../types/bouquetTypes.js'\n\nexport type ProviderStore = {\n\tprovider: BrowserProvider\n\t_clearEvents: () => unknown\n\tauthSigner: HDNodeWallet,\n\twalletAddress: EthereumAddress\n\tchainId: bigint,\n\tisInterceptor: boolean\n}\n\nconst addProvider = async (\n\tstore: Signal<ProviderStore | undefined>,\n\tprovider: BrowserProvider,\n\tclearEvents: () => unknown,\n\tisInterceptor: boolean\n) => {\n\tconst [signer, network] = await Promise.all([provider.getSigner(), provider.getNetwork()])\n\tconst address = await signer.getAddress()\n\tif (store.peek()) removeProvider(store)\n\n\tconst parsedAddress = AddressParser.parse(getAddress(address))\n\tif (!parsedAddress.success) throw new Error('Provider provided invalid address!')\n\n\tstore.value = {\n\t\tprovider,\n\t\tauthSigner: Wallet.createRandom(),\n\t\twalletAddress: parsedAddress.value,\n\t\tchainId: network.chainId,\n\t\t_clearEvents: clearEvents,\n\t\tisInterceptor\n\t}\n}\n\nconst removeProvider = async (store: Signal<ProviderStore | undefined>) => {\n\tif (store.peek()) store.peek()?._clearEvents()\n\tstore.value = undefined\n}\n\nexport const connectBrowserProvider = async (\n\tstore: Signal<ProviderStore | undefined>,\n\tblockInfo: Signal<{\n\t\tblockNumber: bigint\n\t\tbaseFee: bigint\n\t\tpriorityFee: bigint\n\t}>,\n\tsigners: Signal<Signers> | undefined,\n\tbouquetSettings: Signal<BouquetSettings>\n) => {\n\tif (!window.ethereum || !window.ethereum.request) throw new Error('No injected wallet detected')\n\tawait window.ethereum.request({ method: 'eth_requestAccounts' }).catch((err: { code: number }) => {\n\t\tif (err.code === 4001) {\n\t\t\tthrow new Error('Connect Wallet: Wallet connection rejected')\n\t\t} else {\n\t\t\tthrow new Error(`Connect Wallet: ${JSON.stringify(err)}`)\n\t\t}\n\t})\n\n\tconst provider = new BrowserProvider(window.ethereum, 'any')\n\n\tconst blockCallback = async (blockNumber: number) => {\n\t\tconst block = await provider.getBlock(blockNumber)\n\t\tif (block) updateLatestBlock(block, store, blockInfo, signers)\n\t}\n\n\tconst disconnectEventCallback = () => {\n\t\tremoveProvider(store)\n\t}\n\tconst accountsChangedCallback = (accounts: string[]) => {\n\t\tif (accounts.length === 0) {\n\t\t\tremoveProvider(store)\n\t\t} else {\n\t\t\tconst parsedAddress = AddressParser.parse(getAddress(accounts[0]))\n\t\t\tif (!parsedAddress.success) throw new Error('Provider provided invalid address!')\n\t\t\tstore.value = store.value ? { ...store.value, walletAddress: parsedAddress.value } : undefined\n\t\t}\n\t}\n\tconst chainChangedCallback = async (chainId: string) => {\n\t\tbatch(() => {\n\t\t\tbouquetSettings.value = fetchSettingsFromStorage()\n\t\t\tif (store.value) store.value = { ...store.value, chainId: BigInt(chainId) }\n\t\t})\n\n\t\tconst [accounts, block] = await Promise.all([provider.listAccounts(), provider.getBlock('latest')])\n\t\tif (accounts.length > 0 && window.ethereum) {\n\t\t\tclearEvents()\n\t\t\twindow.ethereum.on('disconnect', disconnectEventCallback)\n\t\t\twindow.ethereum.on('accountsChanged', accountsChangedCallback)\n\t\t\twindow.ethereum.on('chainChanged', chainChangedCallback)\n\t\t\tprovider.on('block', blockCallback)\n\t\t}\n\t\taccountsChangedCallback(await Promise.all(accounts.map(account => account.getAddress())))\n\t\tif (block) updateLatestBlock(block, store, blockInfo, signers)\n\t}\n\n\tconst block = await provider.getBlock('latest')\n\tif (block) await updateLatestBlock(block, store, blockInfo, signers)\n\n\twindow.ethereum.on('disconnect', disconnectEventCallback)\n\twindow.ethereum.on('accountsChanged', accountsChangedCallback)\n\twindow.ethereum.on('chainChanged', chainChangedCallback)\n\tprovider.on('block', blockCallback)\n\n\tconst clearEvents = () => {\n\t\twindow.ethereum?.removeListener('disconnect', disconnectEventCallback)\n\t\twindow.ethereum?.removeListener('accountsChanged', accountsChangedCallback)\n\t\twindow.ethereum?.removeListener('chainChanged', chainChangedCallback)\n\t\tprovider.removeListener('block', blockCallback)\n\t}\n\n\tconst [getSimulationStack] = await Promise.allSettled([window.ethereum.request({ method: 'interceptor_getSimulationStack', params: ['1.0.0'] })])\n\tconst isInterceptor = getSimulationStack.status === 'fulfilled'\n\n\taddProvider(store, provider, clearEvents, isInterceptor)\n}\n\nexport async function updateLatestBlock(\n\tblock: Block,\n\tprovider: Signal<ProviderStore | undefined>,\n\tblockInfo: Signal<BlockInfo>,\n\tsigners: Signal<Signers> | undefined,\n) {\n\tconst baseFee = block.baseFeePerGas ? block.baseFeePerGas : 0n\n\tblockInfo.value = { ...blockInfo.value, blockNumber: BigInt(block.number ?? 0n), baseFee }\n\tif (provider.value && signers && signers.value.burner) {\n\t\tprovider.value.provider.getBalance(signers.value.burner.address).then((burnerBalance) => signers.value = { ...signers.value, burnerBalance})\n\t}\n}\n"]}