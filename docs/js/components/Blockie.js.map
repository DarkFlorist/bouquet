{"version":3,"file":"Blockie.js","sourceRoot":"","sources":["../../ts/components/Blockie.tsx"],"names":[],"mappings":"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","sourcesContent":["import { JSX } from 'preact/jsx-runtime'\nimport { ReadonlySignal, Signal, useSignalEffect } from '@preact/signals'\nimport { useAsyncState } from '../library/asyncState.js'\nimport { DataURLCache } from '../library/DataURLCache.js'\n\nconst dataURLCache = new DataURLCache()\n\nclass Future<T> implements PromiseLike<T> {\n\tprivate promise: Promise<T>\n\tprivate resolveFunction: (value: T | PromiseLike<T>) => void\n\tprivate rejectFunction: (reason: Error) => void\n\n\tconstructor() {\n\t\tlet resolveFunction: (value: T | PromiseLike<T>) => void\n\t\tlet rejectFunction: (reason: Error) => void\n\t\tthis.promise = new Promise((resolve: (value: T | PromiseLike<T>) => void, reject: (reason: Error) => void) => {\n\t\t\tresolveFunction = resolve\n\t\t\trejectFunction = reject\n\t\t})\n\t\t// the function passed to the Promise constructor is called before the constructor returns, so we can be sure the resolve and reject functions have been set by here even if the compiler can't verify\n\t\tthis.resolveFunction = resolveFunction!\n\t\tthis.rejectFunction = rejectFunction!\n\t}\n\n\tpublic get asPromise() { return this.promise }\n\n\tpublic readonly then = <TResult1 = T, TResult2 = never>(\n\t\tonfulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | undefined | null,\n\t\tonrejected?: ((reason: Error) => TResult2 | PromiseLike<TResult2>) | undefined | null\n\t): PromiseLike<TResult1 | TResult2> => {\n\t\treturn this.promise.then(onfulfilled, onrejected)\n\t}\n\n\tpublic readonly resolve = (value: T | PromiseLike<T>) => {\n\t\tthis.resolveFunction!(value)\n\t}\n\n\tpublic readonly reject = (reason: Error) => {\n\t\tthis.rejectFunction!(reason)\n\t}\n}\n\nfunction addressString(address: bigint) {\n\treturn `0x${address.toString(16).padStart(40, '0')}`\n}\n\ninterface BlockieProps {\n\taddress: Signal<bigint> | ReadonlySignal<bigint>,\n\tscale?: Signal<number>,\n\tstyle?: JSX.CSSProperties\n}\n\nfunction generateIdenticon(address: bigint, scale: number, canvasRef: HTMLCanvasElement) {\n\t// NOTE -- Majority of this code is referenced from: https://github.com/alexvandesande/blockies\n\t// Mostly to ensure congruence to Ethereum Mist's Identicons\n\n\t// The random number is a js implementation of the Xorshift PRNG\n\tconst randseed = new Array(4) // Xorshift: [x, y, z, w] 32 bit values\n\n\tfunction seedrand(seed: string) {\n\t\tfor (let i = 0; i < randseed.length; i++) {\n\t\t\trandseed[i] = 0\n\t\t}\n\t\tfor (let i = 0; i < seed.length; i++) {\n\t\t\trandseed[i % 4] = ((randseed[i % 4] << 5) - randseed[i % 4]) + seed.charCodeAt(i)\n\t\t}\n\t}\n\n\tfunction rand() {\n\t\t// based on Java's String.hashCode(), expanded to 4 32bit values\n\t\tconst t = randseed[0] ^ (randseed[0] << 11)\n\n\t\trandseed[0] = randseed[1]\n\t\trandseed[1] = randseed[2]\n\t\trandseed[2] = randseed[3]\n\t\trandseed[3] = (randseed[3] ^ (randseed[3] >> 19) ^ t ^ (t >> 8))\n\n\t\treturn (randseed[3] >>> 0) / ((1 << 31) >>> 0)\n\t}\n\n\tfunction createColor() {\n\t\t// saturation is the whole color spectrum\n\t\tconst h = Math.floor(rand() * 360)\n\t\t// saturation goes from 40 to 100, it avoids greyish colors\n\t\tconst s = ((rand() * 60) + 40) + '%'\n\t\t// lightness can be anything from 0 to 100, but probabilities are a bell curve around 50%\n\t\tconst l = ((rand() + rand() + rand() + rand()) * 25) + '%'\n\n\t\tconst color = 'hsl(' + h + ',' + s + ',' + l + ')'\n\t\treturn color\n\t}\n\n\tfunction createImageData(size: number) {\n\t\tconst width = size // Only support square icons for now\n\t\tconst height = size\n\n\t\tconst dataWidth = Math.ceil(width / 2)\n\t\tconst mirrorWidth = width - dataWidth\n\n\t\tconst data = []\n\t\tfor (let y = 0; y < height; y++) {\n\t\t\tlet row = []\n\t\t\tfor (let x = 0; x < dataWidth; x++) {\n\t\t\t\t// this makes foreground and background color to have a 43% (1/2.3) probability\n\t\t\t\t// spot color has 13% chance\n\t\t\t\trow[x] = Math.floor(rand() * 2.3)\n\t\t\t}\n\t\t\tconst r = row.slice(0, mirrorWidth)\n\t\t\tr.reverse()\n\t\t\trow = row.concat(r)\n\n\t\t\tfor (let i = 0; i < row.length; i++) {\n\t\t\t\tdata.push(row[i])\n\t\t\t}\n\t\t}\n\n\t\treturn data\n\t}\n\n\tfunction setCanvas(identicon: HTMLCanvasElement, imageData: number[], color: string, scale: number, bgcolor: string, spotcolor: string) {\n\t\tconst width = Math.sqrt(imageData.length)\n\t\tconst size = width * scale\n\n\t\tidenticon.width = size\n\t\tidenticon.style.width = `${size}px`\n\n\t\tidenticon.height = size\n\t\tidenticon.style.height = `${size}px`\n\n\t\tconst cc = identicon.getContext('2d')\n\t\tcc!.fillStyle = bgcolor\n\t\tcc!.fillRect(0, 0, identicon.width, identicon.height)\n\t\tcc!.fillStyle = color\n\n\t\tfor (let i = 0; i < imageData.length; i++) {\n\t\t\t// if data is 2, choose spot color, if 1 choose foreground\n\t\t\tcc!.fillStyle = (imageData[i] === 1) ? color : spotcolor\n\n\t\t\t// if data is 0, leave the background\n\t\t\tif (imageData[i]) {\n\t\t\t\tconst row = Math.floor(i / width)\n\t\t\t\tconst col = i % width\n\n\t\t\t\tcc!.fillRect(col * scale, row * scale, scale, scale)\n\t\t\t}\n\t\t}\n\t}\n\n\tconst seed = addressString(address)\n\n\tseedrand(seed)\n\n\tconst color = createColor()\n\tconst bgcolor = createColor()\n\tconst spotcolor = createColor()\n\tconst imageData = createImageData(8)\n\tconst canvas = setCanvas(canvasRef, imageData, color, scale, bgcolor, spotcolor)\n\n\treturn canvas\n}\n\nasync function renderBlockieToUrl(address: Signal<bigint>, scale: Signal<number> | undefined) {\n\tconst key = `${address.value}!${scale?.value || 4}`\n\tconst cacheResult = dataURLCache.get(key)\n\tif (cacheResult !== undefined) return cacheResult\n\tconst future = new Future<string>()\n\tconst element = document.createElement('canvas')\n\tgenerateIdenticon(address.value, scale?.value || 4, element)\n\telement.toBlob((blob) => {\n\t\tif (!blob) return\n\t\tconst dataUrl = URL.createObjectURL(blob)\n\t\tdataURLCache.set(dataUrl, key)\n\t\tfuture.resolve(dataUrl)\n\t})\n\treturn await future\n}\n\nexport function Blockie(props: BlockieProps) {\n\tconst dimension = 8 * (props.scale?.value || 4)\n\tconst { value: dataURL, waitFor } = useAsyncState<string>()\n\tuseSignalEffect(() => {\n\t\tprops.address.value\n\t\twaitFor(async () => renderBlockieToUrl(props.address, props.scale))\n\t})\n\treturn <img\n\t\tsrc={dataURL.value.state !== 'resolved' ? 'data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=' : dataURL.value.value}\n\t\tstyle={\n\t\t\t{\n\t\t\t\t...props.style,\n\t\t\t\twidth: `${dimension}px`,\n\t\t\t\theight: `${dimension}px`,\n\t\t\t\tminWidth: `${dimension}px`,\n\t\t\t\tminHeight: `${dimension}px`,\n\t\t\t}\n\t\t}\n\t/>\n}\n"]}